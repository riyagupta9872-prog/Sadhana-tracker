<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sadhana Tracker | Final Audit</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; --danger: #e74c3c; --light: #f4f7f6; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; padding: 0; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none !important; }
        input, select, button { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: var(--secondary); color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { background: #ddd; padding: 10px 20px; border-radius: 20px; width: auto; white-space: nowrap; color: #333; }
        .tab-btn.active { background: var(--secondary); color: white; }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: white; margin-bottom: 5px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <section id="auth-section" class="card">
        <h2 style="text-align: center;">Sadhana Tracker</h2>
        <form id="login-form">
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit">Login / Register</button>
        </form>
    </section>

    <section id="dashboard-section" class="hidden">
        <div class="header" style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div id="user-info">
                <h3 id="display-name" style="margin:0;"></h3>
                <small id="display-rounds"></small>
            </div>
            <button id="logout-btn" style="width:auto; background:#95a5a6; padding: 5px 15px;">Logout</button>
        </div>
        
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('sadhana')">Daily Entry</button>
            <button class="tab-btn" onclick="switchTab('reports')">My Reports</button>
            <button class="tab-btn hidden" id="admin-tab-btn" onclick="switchTab('admin')">Admin Panel</button>
        </div>

        <div id="sadhana-tab" class="tab-content">
            <div class="card">
                <h3>Submit Today's Sadhana</h3>
                <form id="sadhana-form">
                    <label>Date:</label><select id="sadhana-date" required></select>
                    <label>Bed Time (Yesterday Sleep):</label><input type="time" id="sleep-time" required>
                    <label>Wake Up:</label><input type="time" id="wakeup-time" required>
                    <label>Chanting time (Last round by):</label><input type="time" id="chanting-time" required>
                    <label>Pathan (Reading Minutes):</label><input type="number" id="reading-minutes" required>
                    <label>Sarwan (Hearing Minutes):</label><input type="number" id="hearing-minutes" required>
                    <label>Day Sleep (Minutes):</label><input type="number" id="day-sleep-minutes" required>
                    <button type="submit">Save Entry</button>
                </form>
            </div>
        </div>

        <div id="reports-tab" class="tab-content hidden">
            <button id="my-excel-btn" style="background:var(--success); margin-bottom:15px;">Download My Full History (Excel)</button>
            <div id="my-history-list"></div>
        </div>

        <div id="admin-tab" class="tab-content hidden">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="master-download-btn" style="background:var(--success);">Master Detailed (Format 3)</button>
                <button id="comparative-download-btn" style="background:#e67e22;">Weekly Comparative (Format 4)</button>
            </div>
            <div class="card">
                <h3>Devotee List</h3>
                <div id="admin-users-list"></div>
            </div>
        </div>
    </section>
</div>

<script>
// --- YOUR CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyDbRy8ZMJAWeTyZVnTphwRIei6jAckagjA",
  authDomain: "sadhana-tracker-b65ff.firebaseapp.com",
  projectId: "sadhana-tracker-b65ff",
  storageBucket: "sadhana-tracker-b65ff.firebasestorage.app",
  messagingSenderId: "926961218888",
  appId: "1:926961218888:web:db8f12ef8256d13f036f7d"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- SCORING LOGIC (STRICT AS PER IMAGES) ---
function calculateScores(d) {
    const toM = (t) => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
    const s = {};
    
    const sl = toM(d.sleepTime);
    if (sl >= 0 && sl <= 300) s.sleep = -5; // Midnight crossover
    else if (sl <= toM("22:30")) s.sleep = 25;
    else if (sl <= toM("22:35")) s.sleep = 20;
    else if (sl <= toM("22:40")) s.sleep = 15;
    else if (sl <= toM("22:45")) s.sleep = 10;
    else if (sl <= toM("22:50")) s.sleep = 5;
    else if (sl <= toM("22:55")) s.sleep = 0;
    else s.sleep = -5;

    const wk = toM(d.wakeupTime);
    if (wk <= toM("05:05")) s.wake = 25;
    else if (wk <= toM("05:10")) s.wake = 20;
    else if (wk <= toM("05:15")) s.wake = 15;
    else if (wk <= toM("05:20")) s.wake = 10;
    else if (wk <= toM("05:25")) s.wake = 5;
    else if (wk <= toM("05:30")) s.wake = 0;
    else s.wake = -5;

    const ch = toM(d.chantingTime);
    if (ch <= toM("09:00")) s.chant = 25;
    else if (ch <= toM("09:30")) s.chant = 20;
    else if (ch <= toM("11:00")) s.chant = 15;
    else if (ch <= toM("14:30")) s.chant = 10;
    else if (ch <= toM("17:00")) s.chant = 5;
    else if (ch <= toM("19:00")) s.chant = 0;
    else s.chant = -5;

    const bracket = (m) => (m >= 30 ? 25 : m >= 25 ? 20 : m >= 20 ? 15 : m >= 15 ? 10 : m >= 10 ? 5 : m >= 5 ? 0 : -5);
    s.read = bracket(d.readingMinutes);
    s.hear = bracket(d.hearingMinutes);
    s.daySlp = d.daySleepMinutes <= 60 ? 25 : -5;
    
    return s;
}

// --- EXCEL LOGIC (AUDIT FORMAT) ---
function downloadAuditExcel(dataArray, fileName) {
    const header = [["Date", "Bed Time (Yesterday Sleep)", "Mks", "Wake Up", "Mks", "Chanting (Last round by)", "Mks", "Day Sleep", "Mks", "Pathan", "Mks", "Sarwan", "Mks", "Total"]];
    const rows = dataArray.map(r => [r.date, r.sleepTime, r.scores.sleep, r.wakeupTime, r.scores.wake, r.chantingTime, r.scores.chant, r.daySleepMinutes, r.scores.daySlp, r.readingMinutes, r.scores.read, r.hearingMinutes, r.scores.hear, r.total]);
    const finalData = header.concat(rows);
    
    // Add Summary Row (Formula)
    const len = finalData.length;
    finalData.push(["TOTAL", "", {f:`SUM(C2:C${len})`}, "", {f:`SUM(E2:E${len})`}, "", {f:`SUM(G2:G${len})`}, "", {f:`SUM(I2:I${len})`}, "", {f:`SUM(K2:K${len})`}, "", {f:`SUM(M2:M${len})`}, {f:`SUM(N2:N${len})`}]);

    const ws = XLSX.utils.aoa_to_sheet(finalData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Audit");
    XLSX.writeFile(wb, fileName + ".xlsx");
}

// --- APP CORE (STABILITY) ---
auth.onAuthStateChanged(async (user) => {
    if (user) {
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists) {
            const up = doc.data();
            document.getElementById('display-name').textContent = up.name;
            document.getElementById('display-rounds').textContent = up.exactRounds + " Rounds";
            if (up.role === 'admin') document.getElementById('admin-tab-btn').classList.remove('hidden');
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            initDates();
        }
    } else {
        document.getElementById('auth-section').classList.remove('hidden');
        document.getElementById('dashboard-section').classList.add('hidden');
    }
});

function initDates() {
    const sel = document.getElementById('sadhana-date'); sel.innerHTML = '';
    for(let i=0; i<3; i++) {
        const d = new Date(); d.setDate(d.getDate()-i);
        const iso = d.toISOString().split('T')[0];
        sel.innerHTML += `<option value="${iso}">${iso}</option>`;
    }
}

document.getElementById('sadhana-form').onsubmit = async (e) => {
    e.preventDefault();
    const date = document.getElementById('sadhana-date').value;
    const entry = {
        sleepTime: document.getElementById('sleep-time').value,
        wakeupTime: document.getElementById('wakeup-time').value,
        chantingTime: document.getElementById('chanting-time').value,
        readingMinutes: parseInt(document.getElementById('reading-minutes').value),
        hearingMinutes: parseInt(document.getElementById('hearing-minutes').value),
        daySleepMinutes: parseInt(document.getElementById('day-sleep-minutes').value),
        date: date
    };
    entry.scores = calculateScores(entry);
    entry.total = Object.values(entry.scores).reduce((a,b) => a+b, 0);
    await db.collection('users').doc(auth.currentUser.uid).collection('sadhana').doc(date).set(entry);
    alert("Entry Saved!");
};

function switchTab(t) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    event.currentTarget.classList.add('active');
    document.getElementById(t + '-tab').classList.remove('hidden');
}

document.getElementById('logout-btn').onclick = () => auth.signOut();
</script>
</body>
</html>
