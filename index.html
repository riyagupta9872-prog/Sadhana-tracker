<script>
// --- UPDATED SCORING LOGIC FOR MIDNIGHT CROSSOVER ---
function calculateMarks(data) {
    const getM = (t) => { 
        const [h, m] = t.split(':').map(Number); 
        return h * 60 + m; 
    };
    const s = {};
    
    // Sleep Logic Fix: Handle 12 AM to 5 AM as -5
    const sl = getM(data.sleepTime);
    if (sl >= 0 && sl <= 300) { // 12:00 AM to 5:00 AM
        s.sleep = -5;
    } else {
        s.sleep = sl <= getM("22:30") ? 25 : (sl <= getM("22:55") ? 25 - (Math.ceil((sl - getM("22:30"))/5)*5) : -5);
    }

    const wk = getM(data.wakeupTime);
    s.wakeup = wk <= getM("05:05") ? 25 : (wk <= getM("05:30") ? 25 - (Math.ceil((wk - getM("05:05"))/5)*5) : -5);
    
    const ch = getM(data.chantingTime);
    s.chanting = ch <= getM("09:00") ? 25 : (ch <= getM("19:00") ? 25 - (Math.ceil((ch - getM("09:00"))/30)*5) : -5);
    
    s.daySleep = data.daySleepMinutes <= 60 ? 25 : -5;
    s.reading = data.readingMinutes >= 30 ? 25 : (data.readingMinutes >= 5 ? (Math.floor(data.readingMinutes/5)-1)*5 : -5);
    s.hearing = data.hearingMinutes >= 30 ? 25 : (data.hearingMinutes >= 5 ? (Math.floor(data.hearingMinutes/5)-1)*5 : -5);
    
    return s;
}

// --- UPDATED MASTER EXCEL LOGIC (DATA + MARKS) ---
async function downloadAllUsersReport() {
    const usersSnap = await db.collection('users').get();
    let master = [];
    for (const uDoc of usersSnap.docs) {
        const u = uDoc.data();
        const sSnap = await uDoc.ref.collection('sadhana').orderBy('submittedAt','asc').get();
        sSnap.forEach(d => {
            const e = d.data();
            master.push({
                "Name": u.name, 
                "Category": u.chantingCategory, 
                "Date": d.id,
                "Sleep Time": e.sleepTime, "Marks_Sleep": e.scores.sleep,
                "Wake Time": e.wakeupTime, "Marks_Wake": e.scores.wakeup,
                "Chant Time": e.chantingTime, "Marks_Chant": e.scores.chanting,
                "Read (Min)": e.readingMinutes, "Marks_Read": e.scores.reading,
                "Hear (Min)": e.hearingMinutes, "Marks_Hear": e.scores.hearing,
                "DaySleep (Min)": e.daySleepMinutes, "Marks_DaySleep": e.scores.daySleep,
                "Total Day Score": e.totalScore
            });
        });
    }
    const ws = XLSX.utils.json_to_sheet(master);
    const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, ws, "Sadhana_Master");
    XLSX.writeFile(wb, `Master_Sadhana_All_Users.xlsx`);
}
</script>
