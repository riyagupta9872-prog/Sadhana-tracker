<!DOCTYPE html>
<html>
<head>
  <title>Sadhana Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #000080;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 420px;
      color: #000080;
    }
    h3 { text-align: center; margin-top: 0; }
    label { display: block; margin-top: 10px; }
    input, select {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
    }
    button {
      width: 100%;
      margin-top: 12px;
      padding: 8px;
      background: #000080;
      color: white;
      border: none;
      cursor: pointer;
    }
    .success { color: green; text-align: center; margin-top: 8px; }
    .error { color: #b00000; text-align: center; margin-top: 8px; }
  </style>
</head>

<body>

<!-- LOADING -->
<div class="card" id="loading">
  <h3>Checking session‚Ä¶</h3>
</div>

<!-- LOGIN -->
<div class="card" id="login" style="display:none;">
  <h3>Login</h3>
  <input id="email" placeholder="Email" autocomplete="off">
  <input id="password" type="password" placeholder="Password" autocomplete="off">
  <button onclick="loginUser()">Login</button>
</div>

<!-- PROFILE SETUP -->
<div class="card" id="profile" style="display:none;">
  <h3>Profile Setup</h3>

  <label>Name</label>
  <input id="profileName" autocomplete="off">

  <label>Chanting Category</label>
  <select id="profileCategory">
    <option value="">Select category</option>
    <option value="0-4">0‚Äì4 rounds</option>
    <option value="5-9">5‚Äì9 rounds</option>
    <option value="10-16">10‚Äì16 rounds</option>
  </select>

  <button onclick="saveProfile()">Save Profile</button>
  <div id="profileError" class="error"></div>
</div>

<!-- SADHANA -->
<div class="card" id="sadhana" style="display:none;">
  <h3>Daily Sadhana</h3>

  <label>Date</label>
  <select id="date"></select>

  <label>Sleep Time</label>
  <input type="time" id="sleep" autocomplete="off">

  <label>Wake Time</label>
  <input type="time" id="wake" autocomplete="off">

  <label>Chanting Completion</label>
  <input type="time" id="chant" autocomplete="off">

  <label>Reading (minutes)</label>
  <input type="number" id="read" autocomplete="off">

  <label>Hearing (minutes)</label>
  <input type="number" id="hear" autocomplete="off">

  <label>Day Sleep (minutes)</label>
  <input type="number" id="daysleep" autocomplete="off">

  <button onclick="submitSadhana()">Submit Sadhana</button>
  <div id="msgSuccess" class="success"></div>
  <div id="msgError" class="error"></div>

  <button onclick="logoutUser()">Logout</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDbRy8ZMJAWeTyZVnTphwRIei6jAckagjA",
    authDomain: "sadhana-tracker-b65ff.firebaseapp.com",
    projectId: "sadhana-tracker-b65ff",
    appId: "1:926961218888:web:db8f12ef8256d13f036f7d"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  let uid = null;

  function clearSadhanaForm() {
    sleep.value = wake.value = chant.value = read.value = hear.value = daysleep.value = "";
  }

  auth.onAuthStateChanged(async user => {
    loading.style.display = "none";

    if (!user) {
      login.style.display = "block";
      profile.style.display = "none";
      sadhana.style.display = "none";
      return;
    }

    uid = user.uid;
    login.style.display = "none";

    const userDoc = await db.collection("users").doc(uid).get();

    if (!userDoc.exists) {
      profile.style.display = "block";
      sadhana.style.display = "none";
    } else {
      profile.style.display = "none";
      sadhana.style.display = "block";
      setupDates();
      clearSadhanaForm();
    }
  });

  function setupDates() {
    date.innerHTML = "";
    const today = new Date();
    for (let i = 0; i <= 2; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      const v = d.toISOString().slice(0,10);
      const opt = document.createElement("option");
      opt.value = v;
      opt.text = v;
      date.appendChild(opt);
    }
  }

  function loginUser() {
    auth.signInWithEmailAndPassword(email.value, password.value)
      .catch(err => alert(err.message));
  }

  function logoutUser() {
    auth.signOut();
  }

  async function saveProfile() {
    profileError.innerText = "";
    if (!profileName.value || !profileCategory.value) {
      profileError.innerText = "Name and chanting category are mandatory.";
      return;
    }

    await db.collection("users").doc(uid).set({
      name: profileName.value,
      chantingCategory: profileCategory.value,
      createdAt: new Date()
    });

    profile.style.display = "none";
    sadhana.style.display = "block";
    setupDates();
    clearSadhanaForm();
  }

  async function submitSadhana() {
    msgSuccess.innerText = "";
    msgError.innerText = "";

    const values = [sleep.value, wake.value, chant.value, read.value, hear.value, daysleep.value];
    if (values.some(v => v === "")) {
      msgError.innerText = "All sadhana activities are compulsory.";
      return;
    }

    await db.collection("users").doc(uid)
      .collection("sadhana").doc(date.value)
      .set({
        sleepTime: sleep.value,
        wakeTime: wake.value,
        chantingTime: chant.value,
        reading: read.value,
        hearing: hear.value,
        daySleep: daysleep.value
      });

    msgSuccess.innerText = "Sadhana submitted successfully üôè";
    clearSadhanaForm();
  }
</script>

</body>
</html>