<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sadhana Tracker | Final Verified</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; --danger: #e74c3c; --light: #f4f7f6; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: var(--secondary); color: white; border: none; cursor: pointer; font-weight: bold; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { background: #ddd; padding: 10px 20px; border-radius: 20px; width: auto; white-space: nowrap; }
        .tab-btn.active { background: var(--secondary); color: white; }
        .admin-table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: white; margin-bottom: 5px; border-radius: 8px; }
        .user-actions { display: flex; gap: 5px; }
        .user-actions button { width: auto; padding: 6px 12px; font-size: 12px; margin: 0; }
        .week-card { background: #fff; border-left: 5px solid var(--secondary); margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .week-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; }
        .week-content { padding: 15px; border-top: 1px solid #eee; }
        .day-row { padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; line-height: 1.6; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 95%; max-width: 850px; max-height: 90vh; padding: 25px; border-radius: 12px; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 20px; font-size: 30px; cursor: pointer; }
        .edit-prof-btn { background: #9b59b6; width: auto; padding: 5px 15px; font-size: 12px; margin-top: 5px;}
    </style>
</head>
<body>

<div class="container">
    <section id="auth-section" class="card">
        <h2 style="text-align: center;">Sadhana Tracker</h2>
        <form id="login-form">
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
    </section>

    <section id="profile-section" class="card hidden">
        <h2 id="profile-title">Complete Profile</h2>
        <form id="profile-form">
            <input type="text" id="profile-name" placeholder="Full Name" required>
                        <select id="profile-chanting" required>
                <option value="">Select Category</option>
                <option value="Level-1">Level-1 (0-4 Rounds)</option>
                <option value="Level-2">Level-2 (5-8 Rounds)</option>
                <option value="Level-3">Level-3 (9-16 Rounds)</option>
                <option value="Level-4">Level-4 (16+ Coordinator)</option>
            </select>
            <input type="number" id="profile-exact-rounds" placeholder="Exact Rounds Chanting Currently" required min="0">
            <button type="submit" id="profile-save-btn">Save Profile</button>
            <button type="button" onclick="showSection('dashboard')" id="cancel-edit" class="hidden" style="background:#95a5a6;">Cancel</button>
        </form>
    </section>

    <section id="dashboard-section" class="hidden">
        <div class="header">
            <div>
                <h3 id="user-display-name" style="margin:0;"></h3>
                <button class="edit-prof-btn" onclick="openProfileEdit()">Edit Profile / Progress</button>
            </div>
            <button id="logout-btn" style="width: auto; background: #95a5a6; padding: 5px 15px;">Logout</button>
        </div>
        
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('sadhana')">Entry</button>
            <button class="tab-btn" onclick="switchTab('reports')">My Reports</button>
            <button class="tab-btn hidden" id="admin-tab-btn" onclick="switchTab('admin')">Admin</button>
        </div>

        <div id="sadhana-tab" class="tab-content">
            <div class="card">
                <h3>Submit Daily Sadhana</h3>
                                <form id="sadhana-form" autocomplete="off">
                    <label>Date:</label><select id="sadhana-date" required></select>
                    <label>Bed Time (Yesterday Sleep):</label><input type="time" id="sleep-time" required>
                    <label>Wake Up:</label><input type="time" id="wakeup-time" required>
                    <label>Chanting time (Last round by):</label><input type="time" id="chanting-time" required>
                    
                    <label><b>Reading:</b></label>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="reading-hrs" placeholder="Hrs" min="0">
                        <input type="number" id="reading-mins" placeholder="Mins" min="0" max="59">
                    </div>

                    <label><b>Hearing:</b></label>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="hearing-hrs" placeholder="Hrs" min="0">
                        <input type="number" id="hearing-mins" placeholder="Mins" min="0" max="59">
                    </div>

                    <div id="service-area" class="hidden">
                        <label><b>Service:</b></label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="service-hrs" placeholder="Hrs" min="0">
                            <input type="number" id="service-mins" placeholder="Mins" min="0" max="59">
                        </div>
                    </div>

                    <label>Day Sleep (Mins):</label><input type="number" id="day-sleep-minutes" placeholder="0" required>
                    <button type="submit" id="submit-btn">Submit Entry</button>
                </form>
            </div>
        </div>

        <div id="reports-tab" class="tab-content hidden">
            <button id="user-download-btn" style="background: var(--success); margin-bottom: 15px;">Download My Full History (Excel)</button>
            <div id="weekly-reports-container"></div>
        </div>

        <div id="admin-tab" class="tab-content hidden">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button onclick="downloadAllUsersReport()" style="background: var(--success); flex:1;">Master Detailed Report</button>
                <button onclick="downloadComparativeExcel()" style="background: #e67e22; flex:1;">Weekly Comparative Summary</button>
            </div>
            <div class="card" style="overflow-x:auto;">
                <h3>4-Week Comparison</h3>
                <div id="admin-comparative-reports-container"></div>
            </div>
            <div class="card"><h3>User Management</h3><div id="admin-users-list"></div></div>
        </div>
    </section>
</div>

<div id="user-report-modal" class="modal hidden">
    <div class="modal-content">
        <span class="close-btn" onclick="closeUserModal()">&times;</span>
        <h2 id="modal-user-name"></h2><hr>
        <div id="modal-report-container"></div>
    </div>
</div>

<script>
// --- CONFIG & GLOBAL VARS ---
const firebaseConfig = {
  apiKey: "AIzaSyDbRy8ZMJAWeTyZVnTphwRIei6jAckagjA",
  authDomain: "sadhana-tracker-b65ff.firebaseapp.com",
  projectId: "sadhana-tracker-b65ff",
  storageBucket: "sadhana-tracker-b65ff.firebasestorage.app",
  messagingSenderId: "926961218888",
  appId: "1:926961218888:web:db8f12ef8256d13f036f7d"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let currentUser = null, userProfile = null, activeListener = null;

// --- MINUTE-TO-MINUTE SCORING (VERIFIED) ---
function calculateMarks(data) {
    const getM = (t) => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
    const s = {};
    
    // Bedtime Penalty Logic
    const sl = getM(data.sleepTime);
    const sleepCutoff = getM("22:30");
    if (sl >= 0 && sl <= 300) { s.sleep = -5; } // Midnight case
    else { 
        if (sl <= sleepCutoff) s.sleep = 25;
        else s.sleep = Math.max(-5, 25 - (Math.ceil((sl - sleepCutoff)/5)*5));
    }

    // Wakeup Penalty Logic
    const wk = getM(data.wakeupTime);
    const wakeCutoff = getM("05:05");
    if (wk <= wakeCutoff) s.wakeup = 25;
    else s.wakeup = Math.max(-5, 25 - (Math.ceil((wk - wakeCutoff)/5)*5));

    // --- CHANTING LOGIC START ---
    const ch = getM(data.chantingTime);
    
    if (ch < getM("09:00")) {
        s.chanting = 25;
    } else if (ch >= getM("09:00") && ch <= getM("09:30")) {
        s.chanting = 20;
    } else if (ch >= getM("09:31") && ch <= getM("10:59")) {
        s.chanting = 15;
    } else if (ch >= getM("11:00") && ch <= getM("14:30")) { // 2:30 PM
        s.chanting = 10;
    } else if (ch >= getM("14:31") && ch <= getM("17:00")) { // 5:00 PM
        s.chanting = 5;
    } else if (ch >= getM("17:01") && ch <= getM("19:00")) { // 7:00 PM
        s.chanting = 0;
    } else {
        s.chanting = -5; // After 7:00 PM
    }
    // --- CHANTING LOGIC END ---
    
    // Day Sleep Logic
    s.daySleep = data.daySleepMinutes <= 60 ? 25 : -5;
    
    // Reading & Hearing (5 min brackets)
    const calcRH = (m) => (m >= 30 ? 25 : (m >= 5 ? (Math.floor(m/5)-1)*5 : -5));
    s.reading = calcRH(data.readingMinutes);
    s.hearing = calcRH(data.hearingMinutes);
    
    return s;
}

// --- AUTH & PROFILE ---
auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists) {
            userProfile = doc.data();
            document.getElementById('user-display-name').textContent = `${userProfile.name} | Category: ${userProfile.chantingCategory} (${userProfile.exactRounds} Rounds)`;
            if (userProfile.role === 'admin') document.getElementById('admin-tab-btn').classList.remove('hidden');
            showSection('dashboard'); switchTab('sadhana'); setupDateSelect();
            document.getElementById('user-download-btn').onclick = () => downloadExcel(user.uid, userProfile.name);
        } else { showSection('profile'); }
    } else { showSection('auth'); }
});

function openProfileEdit() {
    document.getElementById('profile-title').textContent = "Update Profile";
    document.getElementById('profile-name').value = userProfile.name;
    document.getElementById('profile-chanting').value = userProfile.chantingCategory;
    document.getElementById('profile-exact-rounds').value = userProfile.exactRounds || "";
    document.getElementById('cancel-edit').classList.remove('hidden');
    showSection('profile');
}

document.getElementById('profile-form').onsubmit = async (e) => {
    e.preventDefault();
    const selectedCategory = document.getElementById('profile-chanting').value;
    const updatedData = { 
        name: document.getElementById('profile-name').value, 
        chantingCategory: selectedCategory,
        exactRounds: document.getElementById('profile-exact-rounds').value,
        role: userProfile ? userProfile.role : 'user', 
        email: currentUser.email
    };
    try {
        await db.collection('users').doc(currentUser.uid).set(updatedData, {merge: true});
        alert("Profile Updated Successfully!");
        location.reload(); 
    } catch (error) {
        alert("Error: " + error.message);
    }
};

function showSection(id) {
    ['auth', 'profile', 'dashboard'].forEach(s => document.getElementById(s + '-section').classList.add('hidden'));
    document.getElementById(id + '-section').classList.remove('hidden');
}

function setupDateSelect() {
    const s = document.getElementById('sadhana-date'); s.innerHTML = '';
    for(let i=0; i<3; i++) {
        const d = new Date(); d.setDate(d.getDate()-i);
        const iso = d.toISOString().split('T')[0];
        const opt = document.createElement('option'); opt.value = iso; opt.textContent = iso;
        s.appendChild(opt);
    }
}

document.getElementById('login-form').onsubmit = (e) => {
    e.preventDefault();
    auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => alert(err.message));
};

document.getElementById('sadhana-form').onsubmit = async (e) => {
    e.preventDefault();
    const date = document.getElementById('sadhana-date').value;
    const entry = {
        sleepTime: document.getElementById('sleep-time').value,
        wakeupTime: document.getElementById('wakeup-time').value,
        chantingTime: document.getElementById('chanting-time').value,
        readingMinutes: parseInt(document.getElementById('reading-minutes').value) || 0,
        hearingMinutes: parseInt(document.getElementById('hearing-minutes').value) || 0,
        daySleepMinutes: parseInt(document.getElementById('day-sleep-minutes').value) || 0,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    entry.scores = calculateMarks(entry);
    entry.totalScore = Object.values(entry.scores).reduce((a,b) => a+b, 0);
    await db.collection('users').doc(currentUser.uid).collection('sadhana').doc(date).set(entry);
    alert("Saved Successfully!"); document.getElementById('sadhana-form').reset(); setupDateSelect();
};

document.getElementById('logout-btn').onclick = () => auth.signOut();

// --- EXCEL GENERATION ---
function generateDetailedRows(snap) {
    const rows = [["Date", "Bed Time (Yesterday Sleep)", "Mks", "Wake Up", "Mks", "Chanting (Last round by)", "Mks", "Day Sleep", "Mks", "Pathan (Reading)", "Mks", "Sarwan (Hearing)", "Mks", "Total Score"]];
    snap.forEach(doc => {
        const e = doc.data();
        rows.push([doc.id, e.sleepTime, e.scores.sleep, e.wakeupTime, e.scores.wakeup, e.chantingTime, e.scores.chanting, e.daySleepMinutes, e.scores.daySleep, e.readingMinutes, e.scores.reading, e.hearingMinutes, e.scores.hearing, e.totalScore]);
    });
    return rows;
}

async function downloadExcel(id, name) {
    const snap = await db.collection('users').doc(id).collection('sadhana').orderBy('submittedAt','asc').get();
    const rows = generateDetailedRows(snap);
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sadhana");
    XLSX.writeFile(wb, `${name}_Audit_Report.xlsx`);
}

async function downloadAllUsersReport() {
    const usersSnap = await db.collection('users').get();
    const wb = XLSX.utils.book_new();
    for (const uDoc of usersSnap.docs) {
        const u = uDoc.data();
        const sSnap = await uDoc.ref.collection('sadhana').orderBy('submittedAt','asc').get();
        const rows = [["Name:", u.name, "Rounds:", u.exactRounds], []].concat(generateDetailedRows(sSnap));
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, u.name.substring(0, 30));
    }
    XLSX.writeFile(wb, `Master_Detailed_Report.xlsx`);
}

async function downloadComparativeExcel() {
    const usersSnap = await db.collection('users').get();
    const weeks = []; for(let i=0; i<4; i++) {
        const d = new Date(); d.setDate(d.getDate() - (i*7)); weeks.push(getWeekInfo(d));
    }
    weeks.reverse();
    const summaryData = [["Devotee Name", "Current Rounds", ...weeks.map(w => w.label)]];
    for (const uDoc of usersSnap.docs) {
        const u = uDoc.data();
        const row = [u.name, u.exactRounds || 0];
        const sSnap = await uDoc.ref.collection('sadhana').get();
        const sEntries = sSnap.docs.map(d => ({date: d.id, score: d.data().totalScore || 0}));
        weeks.forEach(w => {
            let weekTotal = 0; let curr = new Date(w.sunStr);
            for(let i=0; i<7; i++) {
                const ds = curr.toISOString().split('T')[0];
                const f = sEntries.find(e => e.date === ds);
                weekTotal += f ? f.score : -30;
                curr.setDate(curr.getDate() + 1);
            }
            row.push(weekTotal);
        });
        summaryData.push(row);
    }
    const ws = XLSX.utils.aoa_to_sheet(summaryData);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Weekly Comparison");
    XLSX.writeFile(wb, "Weekly_Comparative_Summary.xlsx");
}

// --- UTILS ---
function getWeekInfo(dateStr) {
    const d = new Date(dateStr);
    const sun = new Date(d); sun.setDate(d.getDate() - d.getDay());
    const sat = new Date(sun); sat.setDate(sun.getDate() + 6);
    const opt = { day: '2-digit', month: 'short' };
    return { sunStr: sun.toISOString().split('T')[0], label: `(${sun.toLocaleDateString('en-GB', opt)} - ${sat.toLocaleDateString('en-GB', opt)})` };
}

window.switchTab = (t) => {
    document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    const btn = document.querySelector(`button[onclick*="switchTab('${t}')"]`);
    if(btn) btn.classList.add('active');
    document.getElementById(t + '-tab').classList.remove('hidden');
    if(t === 'reports') loadReports(currentUser.uid, 'weekly-reports-container');
    if(t === 'admin') loadAdminPanel();
};

function loadReports(userId, containerId) {
    const container = document.getElementById(containerId);
    if (activeListener) activeListener();
    activeListener = db.collection('users').doc(userId).collection('sadhana').orderBy('submittedAt','desc').onSnapshot(snap => {
        const entries = snap.docs.map(d => ({id: d.id, ...d.data()}));
        const weeks = {};
        entries.forEach(e => {
            const w = getWeekInfo(e.id);
            if(!weeks[w.sunStr]) weeks[w.sunStr] = { range: w.label, data: [], total: 0 };
            weeks[w.sunStr].data.push(e); weeks[w.sunStr].total += e.totalScore;
        });
        container.innerHTML = '';
        Object.keys(weeks).sort((a,b) => b.localeCompare(a)).forEach(key => {
            const week = weeks[key];
            const div = document.createElement('div'); div.className = 'week-card';
            div.innerHTML = `<div class="week-header" onclick="this.nextElementSibling.classList.toggle('hidden')">
                <span>Week ${week.range}</span><span>Score: ${week.total}</span></div>
                <div class="week-content hidden">${week.data.map(e => `
                <div class="day-row">
                    <strong>Date: ${e.id} | Score: ${e.totalScore}</strong><br>
                    <small>Bed: ${e.sleepTime}(${e.scores.sleep}) | Wake: ${e.wakeupTime}(${e.scores.wakeup}) | Chant: ${e.chantingTime}(${e.scores.chanting})<br>
                    Read: ${e.readingMinutes}m(${e.scores.reading}) | Hear: ${e.hearingMinutes}m(${e.scores.hearing}) | DaySleep: ${e.daySleepMinutes}m(${e.scores.daySleep})</small>
                </div>`).join('')}</div>`;
            container.appendChild(div);
        });
    });
}

async function loadAdminPanel() {
    const tableContainer = document.getElementById('admin-comparative-reports-container');
    const usersList = document.getElementById('admin-users-list');
    tableContainer.innerHTML = 'Analyzing...'; usersList.innerHTML = '';
    const weeks = []; for(let i=0; i<4; i++) {
        const d = new Date(); d.setDate(d.getDate() - (i*7)); weeks.push(getWeekInfo(d));
    }
    weeks.reverse();
    const usersSnap = await db.collection('users').get();
    let table = `<table class="admin-table"><thead><tr><th>Name</th><th>Rounds</th>${weeks.map(w => `<th>${w.label}</th>`).join('')}</tr></thead><tbody>`;
    for (const uDoc of usersSnap.docs) {
        const u = uDoc.data();
        table += `<tr><td><strong>${u.name}</strong></td><td>${u.exactRounds || 'N/A'}</td>`;
        const sSnap = await uDoc.ref.collection('sadhana').get();
        const sEntries = sSnap.docs.map(d => ({date: d.id, score: d.data().totalScore || 0}));
        weeks.forEach(w => {
            let weekTotal = 0; let curr = new Date(w.sunStr);
            for(let i=0; i<7; i++) {
                const ds = curr.toISOString().split('T')[0];
                const f = sEntries.find(e => e.date === ds);
                weekTotal += f ? f.score : -30;
                curr.setDate(curr.getDate() + 1);
            }
            table += `<td>${weekTotal}</td>`;
        });
        table += `</tr>`;
        const uItem = document.createElement('div'); uItem.className = 'user-item';
        uItem.innerHTML = `<div><strong>${u.name}</strong><br><small>${u.chantingCategory} (${u.exactRounds} Rounds)</small></div>
            <div class="user-actions">
                <button onclick="openUserModal('${uDoc.id}', '${u.name}')">View</button>
                <button style="background:var(--success);" onclick="downloadExcel('${uDoc.id}', '${u.name}')">Excel</button>
                <button style="background:${u.role === 'admin' ? '#95a5a6' : 'var(--danger)'}" onclick="toggleRole('${uDoc.id}', '${u.role}')">
                    ${u.role === 'admin' ? 'Remove Admin' : 'Make Admin'}
                </button>
            </div>`;
        usersList.appendChild(uItem);
    }
    tableContainer.innerHTML = table + '</tbody></table>';
}

async function toggleRole(id, current) {
    const next = current === 'admin' ? 'user' : 'admin';
    if(confirm(`Are you sure you want to change role to ${next}?`)) { await db.collection('users').doc(id).update({ role: next }); loadAdminPanel(); }
}

window.openUserModal = (id, name) => {
    document.getElementById('user-report-modal').classList.remove('hidden');
    document.getElementById('modal-user-name').textContent = name; loadReports(id, 'modal-report-container');
};
window.closeUserModal = () => { document.getElementById('user-report-modal').classList.add('hidden'); if (activeListener) activeListener(); };
</script>
</body>
</html>
